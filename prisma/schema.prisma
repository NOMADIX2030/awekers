generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider     = "mysql"
  url          = env("DATABASE_URL")
  relationMode = "prisma"
}

model Blog {
  id          Int               @id @default(autoincrement())
  title       String            @db.VarChar(255)
  summary     String            @db.Text
  content     String            @db.Text
  tag         String            @db.VarChar(255)
  image       String            @db.Text
  date        DateTime          @default(now())
  view        Int               @default(0)
  comments    Comment[]
  visits      PageVisit[]
  performance PagePerformance[]

  // ğŸš€ ê·¹í•œ ì„±ëŠ¥ ìµœì í™” ì¸ë±ìŠ¤ (count, aggregate ì¿¼ë¦¬ ìµœì í™”)
  @@index([id, date]) // Primary ì¡°ê±´ ìµœì í™”
  @@index([view, date]) // ì¸ê¸°ê¸€ ì¡°íšŒ ìµœì í™” (ORDER BY view DESC)
  @@index([date, view]) // ë‚ ì§œìˆœ + ì¡°íšŒìˆ˜ ë³µí•© ìµœì í™”
  @@index([tag, date, view]) // íƒœê·¸ë³„ ì¸ê¸°ê¸€ ìµœì í™”
  
  // ê¸°ì¡´ ì¸ë±ìŠ¤ (ìœ ì§€)
  @@index([tag])
  @@index([date])
  @@index([view])
  @@index([tag, date])
}

model User {
  id        Int             @id @default(autoincrement())
  email     String          @unique
  password  String
  isAdmin   Boolean         @default(false)
  createdAt DateTime        @default(now())
  comments  Comment[]
  likes     CommentLike[]
  reports   CommentReport[]
  visits    PageVisit[]
  
  // ğŸš€ ê·¹í•œ ì„±ëŠ¥ ìµœì í™” ì¸ë±ìŠ¤ (count ì¿¼ë¦¬ ëŒ€í­ ìµœì í™”)
  @@index([id, createdAt]) // Primary ì¡°ê±´ ìµœì í™”
  @@index([createdAt]) // ê°€ì…ì¼ìˆœ ì¡°íšŒ ìµœì í™”
  @@index([isAdmin, createdAt]) // ê´€ë¦¬ìë³„ + ê°€ì…ì¼ìˆœ ìµœì í™”
  @@index([createdAt, isAdmin]) // ìµœì‹  ì‚¬ìš©ì + ê¶Œí•œë³„ ë³µí•© ìµœì í™”
}

/// ì‚¬ì´íŠ¸ í™˜ê²½ì„¤ì • í…Œì´ë¸”
model SiteSetting {
  id        Int      @id @default(autoincrement())
  key       String   @unique
  value     String
  updatedAt DateTime @updatedAt
}

/// ê¶Œí•œ ë ˆë²¨ enum
enum VisibilityLevel {
  GUEST  // ì¼ë°˜ë°©ë¬¸ì (ë¹„ë¡œê·¸ì¸)
  USER   // ì¼ë°˜íšŒì› (ë¡œê·¸ì¸)
  ADMIN  // ê´€ë¦¬ì
}

/// ë©”ë‰´ ê´€ë¦¬ í…Œì´ë¸”
model Menu {
  id              Int             @id @default(autoincrement())
  label           String          @db.VarChar(100)  // ë©”ë‰´ í‘œì‹œëª…
  href            String          @db.VarChar(255)  // ë§í¬ URL
  order           Int             @default(0)       // ì •ë ¬ ìˆœì„œ
  isActive        Boolean         @default(true)    // í™œì„±í™” ì—¬ë¶€
  visibilityLevel VisibilityLevel @default(GUEST)   // ê¶Œí•œë³„ ë…¸ì¶œ ì„¤ì •
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  // í•˜ìœ„ë©”ë‰´ì™€ì˜ ê´€ê³„
  subMenus        SubMenu[]

  // ì„±ëŠ¥ ìµœì í™”ë¥¼ ìœ„í•œ ì¸ë±ìŠ¤
  @@index([order])
  @@index([isActive])
  @@index([visibilityLevel])
  @@index([isActive, visibilityLevel, order])
}

/// í•˜ìœ„ë©”ë‰´ ê´€ë¦¬ í…Œì´ë¸”
model SubMenu {
  id              Int             @id @default(autoincrement())
  parentMenuId    Int                                 // ìƒìœ„ ë©”ë‰´ ID
  label           String          @db.VarChar(100)    // í•˜ìœ„ë©”ë‰´ í‘œì‹œëª…
  href            String          @db.VarChar(255)    // ë§í¬ URL
  icon            String?         @db.VarChar(50)     // ì•„ì´ì½˜ (ì„ íƒì‚¬í•­)
  order           Int             @default(0)         // ì •ë ¬ ìˆœì„œ
  isActive        Boolean         @default(true)      // í™œì„±í™” ì—¬ë¶€
  visibilityLevel VisibilityLevel @default(GUEST)     // ê¶Œí•œë³„ ë…¸ì¶œ ì„¤ì •
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  // ìƒìœ„ ë©”ë‰´ì™€ì˜ ê´€ê³„
  parentMenu      Menu            @relation(fields: [parentMenuId], references: [id], onDelete: Cascade)

  // ì„±ëŠ¥ ìµœì í™”ë¥¼ ìœ„í•œ ì¸ë±ìŠ¤
  @@index([parentMenuId])
  @@index([order])
  @@index([isActive])
  @@index([visibilityLevel])
  @@index([parentMenuId, isActive, visibilityLevel, order])
}

model Comment {
  id        Int             @id @default(autoincrement())
  blogId    Int
  content   String          @db.Text
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt
  userId    Int
  parentId  Int?
  isHidden  Boolean         @default(false)
  blog      Blog            @relation(fields: [blogId], references: [id])
  user      User            @relation(fields: [userId], references: [id])
  parent    Comment?        @relation("CommentToReplies", fields: [parentId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  replies   Comment[]       @relation("CommentToReplies")
  likes     CommentLike[]
  reports   CommentReport[]

  // ğŸš€ ê·¹í•œ ì„±ëŠ¥ ìµœì í™” ì¸ë±ìŠ¤ (ì¤‘ë³µ ì œê±° ë° í†µí•© ìµœì í™”)
  @@index([id, createdAt]) // Primary ì¡°ê±´ ìµœì í™”
  @@index([isHidden, createdAt]) // ëŒ€ì‹œë³´ë“œ ëŒ“ê¸€ ì¡°íšŒ ìµœì í™” (WHERE isHidden = false ORDER BY createdAt DESC)
  @@index([userId, createdAt]) // ì‚¬ìš©ìë³„ ëŒ“ê¸€ ì¡°íšŒ ìµœì í™”
  @@index([createdAt, isHidden, userId]) // ì‹œê°„ìˆœ + ê³µê°œ ì—¬ë¶€ + ì‚¬ìš©ì ë³µí•© ìµœì í™”
  @@index([blogId, isHidden, createdAt]) // ë¸”ë¡œê·¸ë³„ ê³µê°œ ëŒ“ê¸€ ìµœì í™” (í†µí•©, ì¤‘ë³µ ì œê±°)
  
  // ê¸°ë³¸ ë‹¨ì¼ ì»¬ëŸ¼ ì¸ë±ìŠ¤ (í•„ìˆ˜ ìœ ì§€)
  @@index([blogId])
  @@index([userId])
  @@index([createdAt])
  @@index([parentId])
  @@index([isHidden])
}

model CommentLike {
  id        Int      @id @default(autoincrement())
  commentId Int
  userId    Int
  createdAt DateTime @default(now())
  comment   Comment  @relation(fields: [commentId], references: [id])
  user      User     @relation(fields: [userId], references: [id])

  @@unique([commentId, userId])
  @@index([createdAt])
}

model CommentReport {
  id        Int      @id @default(autoincrement())
  commentId Int
  userId    Int
  reason    String   @db.VarChar(255)
  createdAt DateTime @default(now())
  comment   Comment  @relation(fields: [commentId], references: [id])
  user      User     @relation(fields: [userId], references: [id])

  @@unique([commentId, userId])
  @@index([createdAt])
  @@index([reason])
}

/// ì ‘ì†ì í†µê³„ë¥¼ ìœ„í•œ ëª¨ë¸ë“¤
model PageVisit {
  id         Int      @id @default(autoincrement())
  pageUrl    String   @db.VarChar(500)
  pageTitle  String   @db.VarChar(255)
  userId     Int?
  blogId     Int?
  userAgent  String   @db.Text
  ipAddress  String   @db.VarChar(45)
  referrer   String?  @db.VarChar(500)
  deviceType String   @db.VarChar(50)
  browser    String   @db.VarChar(100)
  os         String   @db.VarChar(100)
  country    String?  @db.VarChar(100)
  city       String?  @db.VarChar(100)
  createdAt  DateTime @default(now())
  user       User?    @relation(fields: [userId], references: [id])
  blog       Blog?    @relation(fields: [blogId], references: [id])

  // ğŸš€ ì„±ëŠ¥ ìµœì í™”ë¥¼ ìœ„í•œ ì¸ë±ìŠ¤
  @@index([createdAt])
  @@index([blogId])
  @@index([userId])
  @@index([pageUrl])
  @@index([deviceType])
  @@index([country])
  @@index([blogId, createdAt])
  @@index([pageUrl, createdAt])
}

model DailyStats {
  id                 Int      @id @default(autoincrement())
  date               DateTime @unique
  totalVisits        Int      @default(0)
  uniqueVisitors     Int      @default(0)
  pageViews          Int      @default(0)
  bounceRate         Float    @default(0)
  avgSessionDuration Int      @default(0)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  // ğŸš€ ì„±ëŠ¥ ìµœì í™”ë¥¼ ìœ„í•œ ì¸ë±ìŠ¤
  @@index([date])
  @@index([createdAt])
}

model HourlyStats {
  id        Int      @id @default(autoincrement())
  date      DateTime
  hour      Int
  visits    Int      @default(0)
  pageViews Int      @default(0)
  createdAt DateTime @default(now())

  @@unique([date, hour])
  @@index([date])
  @@index([hour])
  @@index([createdAt])
}

/// SERP ë¶„ì„ì„ ìœ„í•œ ëª¨ë¸ë“¤
model TrafficSource {
  id                 Int      @id @default(autoincrement())
  date               DateTime
  source             String   @db.VarChar(100)
  medium             String   @db.VarChar(100)
  visits             Int      @default(0)
  pageViews          Int      @default(0)
  bounceRate         Float    @default(0)
  avgSessionDuration Int      @default(0)
  createdAt          DateTime @default(now())

  @@unique([date, source, medium])
  @@index([date])
  @@index([source])
  @@index([medium])
  @@index([createdAt])
}

model SearchKeyword {
  id          Int      @id @default(autoincrement())
  date        DateTime
  keyword     String   @db.VarChar(255)
  source      String   @db.VarChar(100)
  visits      Int      @default(0)
  impressions Int      @default(0)
  clicks      Int      @default(0)
  ctr         Float    @default(0)
  avgPosition Float    @default(0)
  createdAt   DateTime @default(now())

  @@unique([date, keyword, source])
  @@index([date])
  @@index([keyword])
  @@index([source])
  @@index([createdAt])
}

model PagePerformance {
  id            Int      @id @default(autoincrement())
  date          DateTime
  pageUrl       String   @db.VarChar(500)
  pageTitle     String   @db.VarChar(255)
  blogId        Int?
  visits        Int      @default(0)
  pageViews     Int      @default(0)
  avgTimeOnPage Int      @default(0)
  bounceRate    Float    @default(0)
  exitRate      Float    @default(0)
  createdAt     DateTime @default(now())
  blog          Blog?    @relation(fields: [blogId], references: [id])

  @@unique([date, pageUrl])
  @@index([date])
  @@index([pageUrl])
  @@index([blogId])
  @@index([createdAt])
}

model SERPInsights {
  id        Int      @id @default(autoincrement())
  date      DateTime
  metric    String   @db.VarChar(100)
  value     Float
  change    Float    @default(0)
  period    String   @db.VarChar(50)
  createdAt DateTime @default(now())

  @@unique([date, metric, period])
  @@index([date])
  @@index([metric])
  @@index([period])
  @@index([createdAt])
}

/// Google Analytics ì„¤ì •
model GoogleAnalyticsConfig {
  id           Int       @id @default(autoincrement())
  propertyId   String    @db.VarChar(100)
  clientId     String    @db.VarChar(255)
  clientSecret String    @db.VarChar(255)
  refreshToken String    @db.Text
  accessToken  String?   @db.Text
  tokenExpiry  DateTime?
  isActive     Boolean   @default(false)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
}

/// ë¬¸ì˜ ìƒíƒœ enum
enum InquiryStatus {
  PENDING    // ëŒ€ê¸°ì¤‘
  PROCESSING // ì²˜ë¦¬ì¤‘
  COMPLETED  // ì™„ë£Œ
  CANCELLED  // ì·¨ì†Œ
}

/// ëŒ€ì‘ ìœ í˜• enum
enum ResponseType {
  RESPONSE       // ê³ ê° ë‹µë³€
  STATUS_CHANGE  // ìƒíƒœ ë³€ê²½
  INTERNAL_MEMO  // ë‚´ë¶€ ë©”ëª¨
}

/// ë¬¸ì˜í•˜ê¸° í…Œì´ë¸”
model Inquiry {
  id           Int           @id @default(autoincrement())
  referenceNo  String        @unique @db.VarChar(50)  // ê³ ê°ìš© ì°¸ì¡°ë²ˆí˜¸ (ì˜ˆ: AWE-2025-000123)
  serviceType  String        @db.VarChar(100)  // ì›í•˜ëŠ” ì„œë¹„ìŠ¤
  name         String        @db.VarChar(100)  // ì´ë¦„
  phone        String        @db.VarChar(50)   // ì—°ë½ì²˜
  email        String        @db.VarChar(255)  // ì´ë©”ì¼
  company      String?       @db.VarChar(255)  // íšŒì‚¬ëª… (ì„ íƒ)
  industry     String        @db.VarChar(100)  // ì—…ì¢…
  category     String        @db.VarChar(100)  // ë¬¸ì˜ 1ì°¨ ì¹´í…Œê³ ë¦¬
  subcategory  String?       @db.VarChar(100)  // ì„¸ë¶€í•­ëª©
  budget       String?       @db.VarChar(100)  // ì˜ˆì‚°
  message      String        @db.Text          // ìƒì„¸ ë¬¸ì˜ ë‚´ìš©
  status       InquiryStatus @default(PENDING) // ì²˜ë¦¬ ìƒíƒœ
  adminResponse String?      @db.Text          // ê´€ë¦¬ì ë‹µë³€ (ë ˆê±°ì‹œ)
  ipAddress    String        @db.VarChar(45)   // IP ì£¼ì†Œ
  userAgent    String        @db.Text          // User Agent
  createdAt    DateTime      @default(now())   // ë¬¸ì˜ ì¼ì‹œ
  updatedAt    DateTime      @updatedAt        // ì—…ë°ì´íŠ¸ ì¼ì‹œ

  // ëŒ€ì‘ íˆìŠ¤í† ë¦¬ì™€ì˜ ê´€ê³„
  responses    InquiryResponse[]

  // ğŸš€ ê·¹í•œ ì„±ëŠ¥ ìµœì í™” ì¸ë±ìŠ¤ (count, groupBy, findMany ì¿¼ë¦¬ ëŒ€í­ ìµœì í™”)
  @@index([id, createdAt]) // Primary ì¡°ê±´ ìµœì í™”
  @@index([status, createdAt]) // ìƒíƒœë³„ ìµœê·¼ ë¬¸ì˜ ìµœì í™” (GROUP BY status + ORDER BY createdAt)
  @@index([createdAt, status]) // ìµœê·¼ ë¬¸ì˜ + ìƒíƒœë³„ ë³µí•© ìµœì í™”
  @@index([serviceType, status, createdAt]) // ì„œë¹„ìŠ¤ë³„ + ìƒíƒœë³„ + ì‹œê°„ìˆœ ë³µí•© ìµœì í™”
  @@index([createdAt, serviceType, status]) // ëŒ€ì‹œë³´ë“œ ìµœì í™” (ORDER BY createdAt DESC)
  
  // ê¸°ì¡´ ì„±ëŠ¥ ìµœì í™” ì¸ë±ìŠ¤ (ìœ ì§€)
  @@index([serviceType])
  @@index([status])
  @@index([createdAt])
  @@index([email])
  @@index([referenceNo])
}

/// ë¬¸ì˜ ëŒ€ì‘ íˆìŠ¤í† ë¦¬ í…Œì´ë¸”
model InquiryResponse {
  id              Int          @id @default(autoincrement())
  inquiryId       Int                              // ë¬¸ì˜ ID
  adminId         String       @db.VarChar(100)    // ë‹´ë‹¹ì ID (ë¡œê·¸ì¸ ê³„ì •)
  adminName       String       @db.VarChar(100)    // ë‹´ë‹¹ì ì´ë¦„
  responseType    ResponseType @default(RESPONSE)  // ëŒ€ì‘ ìœ í˜•
  content         String       @db.Text            // ëŒ€ì‘ ë‚´ìš©
  isVisibleToCustomer Boolean  @default(true)      // ê³ ê° ë…¸ì¶œ ì—¬ë¶€
  createdAt       DateTime     @default(now())     // ëŒ€ì‘ ì‹œê°„

  // ë¬¸ì˜ì™€ì˜ ê´€ê³„
  inquiry         Inquiry      @relation(fields: [inquiryId], references: [id], onDelete: Cascade)

  // ì„±ëŠ¥ ìµœì í™”ë¥¼ ìœ„í•œ ì¸ë±ìŠ¤
  @@index([inquiryId])
  @@index([createdAt])
  @@index([adminId])
  @@index([responseType])
  @@index([inquiryId, createdAt])
}
